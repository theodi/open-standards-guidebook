#!/usr/bin/env node

// This script:
// - Reads the shared project config from the `buildConfig` key in the project's package.json
// - Uses that data to set a local nanobox DNS alias for the CraftCMS install
// - and environment variables (via .env) for
// -- ASSET_SERVER_PORT
// -- FRACTAL_SERVER_PORT
// -- SITE_NAME

require("dotenv").config();
require("colors");

const util = require("util");
const fs = require("fs");
const path = require("path");
const shell = require('shelljs');
const jsonfile = require("jsonfile");

const toDotEnvString = require("../lib/toDotEnvString");

const pkg = jsonfile.readFileSync("package.json");

const dotEnvPath = path.resolve(__dirname, "../../.env");
const dotEnvExamplePath = path.resolve(__dirname, "../../.env.example");


if (!pkg.buildConfig) {
  console.error("Error: looks like this project hasn't been configured yet, is this a new project?".red);
  console.error("Is this a new project? If so you should run `yarn project:configure` first".yellow);
  process.exit(1);
}

function setEnvvars() {
  const output = toDotEnvString({
    assetServerPort: pkg.buildConfig.ports.assets,
    fractalServerPort: pkg.buildConfig.ports.fractal,
    siteName: pkg.buildConfig.siteName,
  });


  fs.appendFileSync(dotEnvExamplePath, '\r\n# GENERATED BY APPLY ENV\r\n', (err) => {
    console.log('err', err);
  });

  fs.appendFileSync(dotEnvExamplePath, output, (err) => {
    console.log('err', err);
  });

  fs.appendFileSync(dotEnvPath, '\r\n# GENERATED BY APPLY ENV\r\n', (err) => {
    console.log('err', err);
  });
  fs.appendFileSync(dotEnvPath, output, (err) => {
    console.log('err', err);
  });

  console.log("Configured environment variables".green);
}


function applyEnv() {
  setEnvvars();
  console.log('done');
}

applyEnv();





